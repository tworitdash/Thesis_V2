c0 = 3e8; % speed of light
R = 2e-2; % Radius of the waveguide

er = 1;
mur = 1;

er0 = 8.85418782e-12; % Free space permittivity
mu0 = 1.25663706e-6;  % Free Space Permeability

epsilon = er * er0;
mu = mur .* mu0;

% F = 5e9;

x = linspace(0.6, 1, 100);
lamb = 2.*R./x;
f = c0./lamb;

% lamb = c0/F;
omega = 2 * pi * F;

k0 = omega./c0;

L = 100;

N = 2:1:20;

Str = load('Xmn_azimuthal_inc_TE.mat');

str = Str.xmn_TE;

for b = 1:length(f)
    
    F = f(b);

for i = 1:length(N)
    
    xmn(i) = str(N(i)).xmn;
    beta_rho(i) = xmn(i)./R;
    M(i) = str(N(i)).m;
    beta_z(i) = -1j .* sqrt(-(k0.^2 - (beta_rho(i)).^2));
    YTE(i) = beta_z(i)./(omega .* mu);
    ZTE(i) = 1./YTE(i);
    
end

for l = 1:length(N)
    for p = 1:length(N)
        if l == p
            Ymut(l, p) = Yin_Circular(N(l), N(p), k0, R, er, mur, L) + YTE(p);
        else
            Ymut(l, p) = Yin_Circular(N(l), N(p), k0, R, er, mur, L);
        end
    end
end

for l = 1:length(N)
    Y_rhs(l) = Yin_Circular(1, N(l), k0, R, er, mur, L);
end

Dm = Ymut\(-Y_rhs.');

Y11 = Yin_Circular(1, 1, k0, R, er, mur, L);

xmn11 = str(1).xmn;
beta_rho11 = xmn11./R;

beta_z11 = -1j .* sqrt(-(k0.^2 - beta_rho11.^2));
YTE11 = beta_z11./(omega .* mu);
ZTE11 = 1./YTE11;

yap(b) = (Y11 + Dm.' * Y_rhs.')./YTE11;

Gamma(b) = (1 - yap())./(1 + yap);

end